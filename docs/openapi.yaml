openapi: 3.0.3
info:
  title: EdgeOne Webhook Pusher API
  description: |
    Serverless æ¶ˆæ¯æ¨é€æœåŠ¡ API
    
    ## API åˆ†ç±»
    
    ### ğŸ” ç®¡ç† API (Admin API)
    éœ€è¦ `X-Admin-Token` é‰´æƒï¼Œç”¨äºåå°ç®¡ç†ç³»ç»Ÿã€‚
    - ç³»ç»Ÿåˆå§‹åŒ–ä¸é…ç½®
    - SendKey / Topic / OpenID ç®¡ç†
    - æ¶ˆæ¯å†å²æŸ¥è¯¢
    - ç»Ÿè®¡æ•°æ®
    
    ### ğŸš€ Webhook API (Push API)
    æ— éœ€é‰´æƒï¼Œç”¨äºå¤–éƒ¨ç³»ç»Ÿè°ƒç”¨æ¨é€æ¶ˆæ¯ã€‚
    - `/{sendKey}.send` - å•å‘æ¨é€
    - `/{topicKey}.topic` - ç¾¤å‘æ¨é€
    
  version: 1.0.0
  license:
    name: GPL-3.0

servers:
  - url: /v1
    description: ç®¡ç† API (Admin API)

tags:
  - name: ç®¡ç† - åˆå§‹åŒ–
    description: ç³»ç»Ÿåˆå§‹åŒ–ï¼ˆé¦–æ¬¡ä½¿ç”¨ï¼‰
  - name: ç®¡ç† - é…ç½®
    description: ç³»ç»Ÿé…ç½®ç®¡ç†
  - name: ç®¡ç† - SendKey
    description: SendKey ç®¡ç†ï¼ˆå•å‘æ¶ˆæ¯é€šé“ï¼‰
  - name: ç®¡ç† - Topic
    description: Topic ç®¡ç†ï¼ˆç¾¤å‘æ¶ˆæ¯é€šé“ï¼‰
  - name: ç®¡ç† - OpenID
    description: å¾®ä¿¡ç”¨æˆ· OpenID ç®¡ç†
  - name: ç®¡ç† - æ¶ˆæ¯
    description: æ¶ˆæ¯å†å²è®°å½•
  - name: ç®¡ç† - ç»Ÿè®¡
    description: ç»Ÿè®¡æ•°æ®
  - name: Webhook - æ¨é€
    description: æ¶ˆæ¯æ¨é€æ¥å£ï¼ˆæ— éœ€é‰´æƒï¼‰

components:
  securitySchemes:
    AdminToken:
      type: apiKey
      in: header
      name: X-Admin-Token
      description: ç®¡ç†å‘˜ Token

  schemas:
    ApiResponse:
      type: object
      properties:
        code:
          type: integer
          description: çŠ¶æ€ç ï¼Œ0 è¡¨ç¤ºæˆåŠŸ
        message:
          type: string
          description: çŠ¶æ€æ¶ˆæ¯
        data:
          description: å“åº”æ•°æ®

    SendKey:
      type: object
      properties:
        id:
          type: string
          example: sk_abc123
        key:
          type: string
          example: SCT1234567890abcdef
        name:
          type: string
          example: æœåŠ¡å™¨ç›‘æ§
        openIdRef:
          type: string
          nullable: true
          example: oid_user1
        bindUrl:
          type: string
          example: https://your-domain.com/v1/bind/sk_abc123
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    Topic:
      type: object
      properties:
        id:
          type: string
          example: tp_xyz789
        key:
          type: string
          example: TPK9876543210fedcba
        name:
          type: string
          example: ç³»ç»Ÿå…¬å‘Š
        subscriberRefs:
          type: array
          items:
            type: string
          example: [oid_user1, oid_user2]
        subscribeUrl:
          type: string
          example: https://your-domain.com/v1/subscribe/tp_xyz789
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    OpenID:
      type: object
      properties:
        id:
          type: string
          example: oid_user1
        openId:
          type: string
          example: oXXXX_xxxxx
        nickname:
          type: string
          example: ç”¨æˆ·æ˜µç§°
        remark:
          type: string
          example: å¤‡æ³¨ä¿¡æ¯
        createdAt:
          type: string
          format: date-time

    Message:
      type: object
      properties:
        id:
          type: string
          example: msg_123456
        type:
          type: string
          enum: [send, topic]
        keyId:
          type: string
        title:
          type: string
        desp:
          type: string
        results:
          type: array
          items:
            type: object
            properties:
              openId:
                type: string
              success:
                type: boolean
              msgId:
                type: string
              error:
                type: string
        createdAt:
          type: string
          format: date-time

    Config:
      type: object
      properties:
        wechat:
          type: object
          properties:
            appId:
              type: string
            appSecret:
              type: string
            token:
              type: string
            encodingAESKey:
              type: string
            templateId:
              type: string

paths:
  # ==========================================
  # ç®¡ç† API - åˆå§‹åŒ–
  # ==========================================
  /init/status:
    get:
      tags: [ç®¡ç† - åˆå§‹åŒ–]
      summary: æ£€æŸ¥åˆå§‹åŒ–çŠ¶æ€
      responses:
        '200':
          description: æˆåŠŸ
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          initialized:
                            type: boolean

  /init:
    post:
      tags: [ç®¡ç† - åˆå§‹åŒ–]
      summary: æ‰§è¡Œåˆå§‹åŒ–
      description: é¦–æ¬¡åˆå§‹åŒ–ç³»ç»Ÿï¼Œç”Ÿæˆ Admin Token
      responses:
        '200':
          description: æˆåŠŸ
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          adminToken:
                            type: string
                          message:
                            type: string

  # ==========================================
  # ç®¡ç† API - é…ç½®
  # ==========================================
  /config:
    get:
      tags: [ç®¡ç† - é…ç½®]
      summary: è·å–ç³»ç»Ÿé…ç½®
      security:
        - AdminToken: []
      responses:
        '200':
          description: æˆåŠŸ
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Config'
    put:
      tags: [ç®¡ç† - é…ç½®]
      summary: æ›´æ–°ç³»ç»Ÿé…ç½®
      security:
        - AdminToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Config'
      responses:
        '200':
          description: æˆåŠŸ

  # ==========================================
  # ç®¡ç† API - SendKey
  # ==========================================
  /sendkeys:
    get:
      tags: [ç®¡ç† - SendKey]
      summary: è·å– SendKey åˆ—è¡¨
      security:
        - AdminToken: []
      responses:
        '200':
          description: æˆåŠŸ
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/SendKey'
    post:
      tags: [ç®¡ç† - SendKey]
      summary: åˆ›å»º SendKey
      security:
        - AdminToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
                openIdRef:
                  type: string
                  description: å¯é€‰ï¼Œç»‘å®šçš„ OpenID
      responses:
        '200':
          description: æˆåŠŸ
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/SendKey'

  /sendkeys/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    get:
      tags: [ç®¡ç† - SendKey]
      summary: è·å– SendKey è¯¦æƒ…
      security:
        - AdminToken: []
      responses:
        '200':
          description: æˆåŠŸ
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/SendKey'
    put:
      tags: [ç®¡ç† - SendKey]
      summary: æ›´æ–° SendKey
      security:
        - AdminToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                openIdRef:
                  type: string
      responses:
        '200':
          description: æˆåŠŸ
    delete:
      tags: [ç®¡ç† - SendKey]
      summary: åˆ é™¤ SendKey
      security:
        - AdminToken: []
      responses:
        '200':
          description: æˆåŠŸ

  /sendkeys/{id}/unbind:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    post:
      tags: [ç®¡ç† - SendKey]
      summary: è§£ç»‘ SendKey
      security:
        - AdminToken: []
      responses:
        '200':
          description: æˆåŠŸ

  # ==========================================
  # ç®¡ç† API - Topic
  # ==========================================
  /topics:
    get:
      tags: [ç®¡ç† - Topic]
      summary: è·å– Topic åˆ—è¡¨
      security:
        - AdminToken: []
      responses:
        '200':
          description: æˆåŠŸ
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Topic'
    post:
      tags: [ç®¡ç† - Topic]
      summary: åˆ›å»º Topic
      security:
        - AdminToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name:
                  type: string
      responses:
        '200':
          description: æˆåŠŸ

  /topics/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    get:
      tags: [ç®¡ç† - Topic]
      summary: è·å– Topic è¯¦æƒ…
      security:
        - AdminToken: []
      responses:
        '200':
          description: æˆåŠŸ
    put:
      tags: [ç®¡ç† - Topic]
      summary: æ›´æ–° Topic
      security:
        - AdminToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
      responses:
        '200':
          description: æˆåŠŸ
    delete:
      tags: [ç®¡ç† - Topic]
      summary: åˆ é™¤ Topic
      security:
        - AdminToken: []
      responses:
        '200':
          description: æˆåŠŸ

  /topics/{id}/subscribers:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    get:
      tags: [ç®¡ç† - Topic]
      summary: è·å– Topic è®¢é˜…è€…åˆ—è¡¨
      security:
        - AdminToken: []
      responses:
        '200':
          description: æˆåŠŸ
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/OpenID'

  /topics/{id}/subscribe/{openIdRef}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
      - name: openIdRef
        in: path
        required: true
        schema:
          type: string
    delete:
      tags: [ç®¡ç† - Topic]
      summary: å–æ¶ˆè®¢é˜…
      security:
        - AdminToken: []
      responses:
        '200':
          description: æˆåŠŸ

  # ==========================================
  # ç®¡ç† API - OpenID
  # ==========================================
  /openids:
    get:
      tags: [ç®¡ç† - OpenID]
      summary: è·å– OpenID åˆ—è¡¨
      security:
        - AdminToken: []
      responses:
        '200':
          description: æˆåŠŸ
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/OpenID'
    post:
      tags: [ç®¡ç† - OpenID]
      summary: åˆ›å»º OpenID
      security:
        - AdminToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [openId]
              properties:
                openId:
                  type: string
                nickname:
                  type: string
                remark:
                  type: string
      responses:
        '200':
          description: æˆåŠŸ

  /openids/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    get:
      tags: [ç®¡ç† - OpenID]
      summary: è·å– OpenID è¯¦æƒ…
      security:
        - AdminToken: []
      responses:
        '200':
          description: æˆåŠŸ
    put:
      tags: [ç®¡ç† - OpenID]
      summary: æ›´æ–° OpenID
      security:
        - AdminToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                nickname:
                  type: string
                remark:
                  type: string
      responses:
        '200':
          description: æˆåŠŸ
    delete:
      tags: [ç®¡ç† - OpenID]
      summary: åˆ é™¤ OpenID
      description: åˆ é™¤å‰ä¼šæ£€æŸ¥æ˜¯å¦è¢« SendKey æˆ– Topic å¼•ç”¨
      security:
        - AdminToken: []
      responses:
        '200':
          description: æˆåŠŸ

  # ==========================================
  # ç®¡ç† API - æ¶ˆæ¯
  # ==========================================
  /messages:
    get:
      tags: [ç®¡ç† - æ¶ˆæ¯]
      summary: è·å–æ¶ˆæ¯å†å²
      security:
        - AdminToken: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: cursor
          in: query
          schema:
            type: string
      responses:
        '200':
          description: æˆåŠŸ
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          items:
                            type: array
                            items:
                              $ref: '#/components/schemas/Message'
                          cursor:
                            type: string
                          hasMore:
                            type: boolean

  /messages/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
    get:
      tags: [ç®¡ç† - æ¶ˆæ¯]
      summary: è·å–æ¶ˆæ¯è¯¦æƒ…
      security:
        - AdminToken: []
      responses:
        '200':
          description: æˆåŠŸ

  # ==========================================
  # ç®¡ç† API - ç»Ÿè®¡
  # ==========================================
  /stats:
    get:
      tags: [ç®¡ç† - ç»Ÿè®¡]
      summary: è·å–ç»Ÿè®¡æ•°æ®
      security:
        - AdminToken: []
      responses:
        '200':
          description: æˆåŠŸ
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          sendKeyCount:
                            type: integer
                          topicCount:
                            type: integer
                          openIdCount:
                            type: integer
                          messageCount:
                            type: integer

  # ==========================================
  # Webhook API - æ¨é€ï¼ˆæ— éœ€é‰´æƒï¼Œä»…æ”¯æŒ GETï¼‰
  # ==========================================
  /{sendKey}.send:
    servers:
      - url: /
        description: Webhook APIï¼ˆæ ¹è·¯å¾„ï¼‰
    parameters:
      - name: sendKey
        in: path
        required: true
        schema:
          type: string
        description: SendKeyï¼Œæ ¼å¼ä¸º SCTxxxxxxxx
        example: SCT1234567890abcdef
    get:
      tags: [Webhook - æ¨é€]
      summary: å•å‘æ¨é€
      description: |
        å‘ SendKey ç»‘å®šçš„ç”¨æˆ·å‘é€æ¶ˆæ¯ã€‚
        
        **ç¤ºä¾‹ï¼š**
        ```
        GET /{sendKey}.send?title=æœåŠ¡å™¨å‘Šè­¦&desp=CPUä½¿ç”¨ç‡è¶…è¿‡90%
        ```
      parameters:
        - name: title
          in: query
          required: true
          schema:
            type: string
          description: æ¶ˆæ¯æ ‡é¢˜ï¼ˆå¿…å¡«ï¼‰
        - name: desp
          in: query
          schema:
            type: string
          description: æ¶ˆæ¯å†…å®¹ï¼ˆå¯é€‰ï¼‰
      responses:
        '200':
          description: æˆåŠŸ
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          pushId:
                            type: string
                          results:
                            type: array
                            items:
                              type: object
                              properties:
                                success:
                                  type: boolean
                                msgId:
                                  type: string

  /{topicKey}.topic:
    servers:
      - url: /
        description: Webhook APIï¼ˆæ ¹è·¯å¾„ï¼‰
    parameters:
      - name: topicKey
        in: path
        required: true
        schema:
          type: string
        description: TopicKeyï¼Œæ ¼å¼ä¸º TPKxxxxxxxx
        example: TPK9876543210fedcba
    get:
      tags: [Webhook - æ¨é€]
      summary: ç¾¤å‘æ¨é€
      description: |
        å‘ Topic çš„æ‰€æœ‰è®¢é˜…è€…å‘é€æ¶ˆæ¯ã€‚
        
        **ç¤ºä¾‹ï¼š**
        ```
        GET /{topicKey}.topic?title=ç³»ç»Ÿå…¬å‘Š&desp=ä»Šæ™š22ç‚¹ç»´æŠ¤
        ```
      parameters:
        - name: title
          in: query
          required: true
          schema:
            type: string
          description: æ¶ˆæ¯æ ‡é¢˜ï¼ˆå¿…å¡«ï¼‰
        - name: desp
          in: query
          schema:
            type: string
          description: æ¶ˆæ¯å†…å®¹ï¼ˆå¯é€‰ï¼‰
      responses:
        '200':
          description: æˆåŠŸ
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          pushId:
                            type: string
                          total:
                            type: integer
                            description: æ€»è®¢é˜…è€…æ•°
                          success:
                            type: integer
                            description: æˆåŠŸæ•°
                          failed:
                            type: integer
                            description: å¤±è´¥æ•°
                          results:
                            type: array
                            items:
                              type: object
                              properties:
                                openId:
                                  type: string
                                success:
                                  type: boolean
                                msgId:
                                  type: string
                                error:
                                  type: string
